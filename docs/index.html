<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <!-- Мета-тег viewport для корректного масштабирования на мобильных устройствах -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollen area available</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      .map {
        width: 100%;
        height: 100%;
        position: relative;
      }
      /* Окно для отображения информации */
      .info-window {
        position: absolute;
        pointer-events: none;
        padding: 4px 6px;
        background: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 2px;
        white-space: nowrap;
        z-index: 1000;
      }
      /* Для мобильных устройств окно выводится в верхней части экрана по центру */
      .mobile-info {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
      }
      /* Центровой указатель для мобильных реализован через inline SVG.
         Он сохраняет постоянную толщину линий независимо от ориентации экрана. */
      .center-pointer {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        z-index: 1100;
      }
      /* Скрываем указатель на десктопе */
      @media (min-width: 768px) {
        .center-pointer {
          display: none;
        }
      }
    
      /* --- Legend + layer toggles (top-right) --- */
      /* Move default zoom control to the top-right so the legend can sit рядом */
      .ol-zoom {
        right: auto !important;
        left: .5em !important;
        top: .5em !important;
      }
      .legend-control {
        top: .5em;
        left: 3.6em; /* чуть правее zoom */
        right: auto;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0,0,0,0.25);
        border-radius: 6px;
        padding: 8px 10px;
        font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: #111;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      }
      .legend-control .title {
        font-weight: 600;
        margin-bottom: 6px;
        opacity: 0.9;
      }
      .legend-control .row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 4px 0;
        white-space: nowrap;
      }
      .legend-control input[type="checkbox"] {
        margin: 0;
      }
      .legend-swatch {
        width: 12px;
        height: 12px;
        border: 1px solid rgba(0,0,0,.6);
        border-radius: 2px;
        flex: 0 0 auto;
      }
      .legend-control .name {
        opacity: 0.95;
      }
      /* На мобиле делаем легенду чуть компактнее */
      @media (max-width: 767px) {
        .legend-control { padding: 6px 8px; right: 3.4em; }
        .legend-control .title { margin-bottom: 4px; }
      }

    </style>
  </head>
  <body>
    <div id="map" class="map">
      <!-- Центровой указатель (виден только на мобильных) с inline SVG -->
      <div id="center-pointer" class="center-pointer">
        <svg width="20" height="20" viewBox="0 0 20 20" style="display:block;">
          <line x1="0" y1="10" x2="8" y2="10" stroke="rgba(0,0,0,0.3)" stroke-width="2" />
          <line x1="12" y1="10" x2="20" y2="10" stroke="rgba(0,0,0,0.3)" stroke-width="2" />
          <line x1="10" y1="0" x2="10" y2="8" stroke="rgba(0,0,0,0.3)" stroke-width="2" />
          <line x1="10" y1="12" x2="10" y2="20" stroke="rgba(0,0,0,0.3)" stroke-width="2" />
        </svg>
      </div>
      <!-- Элемент для отображения информации -->
      <div id="info-window" class="info-window"></div>
    </div>
    
    <!-- Внешний файл с координатами (rotatedPolygon и rotatedPolygonRegional должны быть определены) -->
    <script src="rotatedPolygon.js"></script>
    
    <!-- OpenLayers -->
    <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
    <!-- i18next и плагин для определения языка -->
    <script src="https://unpkg.com/i18next@latest/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@latest/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    
    <script>
      // Функция для определения мобильного устройства
      function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      
      // Инициализация i18next
      i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
          fallbackLng: 'en',
          load: 'languageOnly',
          detection: {
            order: ['querystring', 'navigator'],
            caches: []
          },
          resources: {
            ru: { translation: { lat: 'Широта', lon: 'Долгота' } },
            en: { translation: { lat: 'Lat', lon: 'Lon' } }
          }
        }, function(err, t) {
          console.log('navigator.language:', navigator.language);
          console.log('i18next.language:', i18next.language);
          window.onload = function() {
            // Преобразование координат для основного полигона (SILAM Europe)
            const polygonCoords = rotatedPolygon.map(coord =>
              ol.proj.fromLonLat([coord[1], coord[0]])
            );
            const polygonFeature = new ol.Feature({
              geometry: new ol.geom.Polygon([polygonCoords])
            });
            const vectorSource = new ol.source.Vector({
              features: [polygonFeature]
            });
            const vectorLayer = new ol.layer.Vector({
              source: vectorSource,
              style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: 'rgba(255,200,0,1)',
                  width: 0.5
                }),
                fill: new ol.style.Fill({
                  color: 'rgba(255,255,0,0.2)'
                })
              })
            });
            
            // Преобразование координат для регионального полигона (SILAM Regional)
            const regionalCoords = rotatedPolygonRegional.map(coord =>
              ol.proj.fromLonLat([coord[1], coord[0]])
            );
            const regionalFeature = new ol.Feature({
              geometry: new ol.geom.Polygon([regionalCoords])
            });
            const regionalVectorSource = new ol.source.Vector({
              features: [regionalFeature]
            });
            const regionalVectorLayer = new ol.layer.Vector({
              source: regionalVectorSource,
              style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: 'rgba(0,255,0,1)',
                  width: 0.5
                }),
                fill: new ol.style.Fill({
                  color: 'rgba(0,255,0,0.2)'
                })
              })
            });

            // Преобразование координат для нового полигона (SILAM Hires)
            let hiresVectorLayer = null;
            if (typeof rotatedPolygonHires !== 'undefined') {
              const hiresCoords = rotatedPolygonHires.map(coord =>
                ol.proj.fromLonLat([coord[1], coord[0]])
              );
              const hiresFeature = new ol.Feature({
                geometry: new ol.geom.Polygon([hiresCoords])
              });
              const hiresVectorSource = new ol.source.Vector({
                features: [hiresFeature]
              });
              hiresVectorLayer = new ol.layer.Vector({
                source: hiresVectorSource,
                style: new ol.style.Style({
                  stroke: new ol.style.Stroke({
                    color: 'rgba(0,120,255,1)',
                    width: 0.5
                  }),
                  fill: new ol.style.Fill({
                    color: 'rgba(0,120,255,0.2)'
                  })
                })
              });
            }
            
            // Базовый слой карты
            const rasterLayer = new ol.layer.Tile({
              source: new ol.source.OSM()
            });
            
            // Определяем, мобильное ли устройство и задаем уровень зума
            const isMobile = isMobileDevice();
            const defaultZoom = isMobile ? 6 : 4;

            const layersArr = [rasterLayer, vectorLayer, regionalVectorLayer];
            if (hiresVectorLayer) {
              layersArr.push(hiresVectorLayer);
            }
            

            // -----------------------------------------------------------------
            // Legend + layer toggles (top-right)
            // -----------------------------------------------------------------
            function addCoverageLegend(map, items) {
              const el = document.createElement('div');
              el.className = 'ol-unselectable ol-control legend-control';

              const rowsHtml = items.map((it) => `
                <div class="row">
                  <label>
                    <input type="checkbox" data-layer-id="${it.id}" checked />
                    <span class="legend-swatch" style="background:${it.color};"></span>
                    <span class="name">${it.name}</span>
                  </label>
                </div>
              `).join('');

              el.innerHTML = `
                <div class="title">Coverage</div>
                ${rowsHtml}
              `;

              // чтобы клики по чекбоксам не тащили карту
              el.addEventListener('mousedown', (e) => e.stopPropagation());
              el.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });

              const control = new ol.control.Control({ element: el });
              map.addControl(control);

              el.querySelectorAll('input[type="checkbox"][data-layer-id]').forEach((cb) => {
                cb.addEventListener('change', () => {
                  const id = cb.getAttribute('data-layer-id');
                  const target = items.find((x) => x.id === id);
                  if (target && target.layer) {
                    target.layer.setVisible(cb.checked);
                  }
                });
              });
            }

            // Создаем карту с базовым и векторными слоями
            const map = new ol.Map({
              target: 'map',
              layers: layersArr,
              view: new ol.View({
                center: ol.proj.fromLonLat([20, 20]),
                zoom: defaultZoom
              })
            });
            


            // Добавляем легенду/переключатели слоёв (справа сверху)
            const legendItems = [
              { id: 'europe',   name: 'SILAM Europe (v6.1/v6.0)',     color: 'rgba(255,200,0,1)', layer: vectorLayer },
              { id: 'regional', name: 'SILAM Northern Europe (v5.9.1)', color: 'rgba(0,255,0,1)',   layer: regionalVectorLayer },
            ];
            if (hiresVectorLayer) {
              legendItems.unshift({ id: 'hires', name: 'SILAM Finland (v6.1)', color: 'rgba(0,120,255,1)', layer: hiresVectorLayer });
            }
            addCoverageLegend(map, legendItems);
            // Элемент для отображения информации
            const infoWindow = document.getElementById('info-window');
            if (isMobile) {
              infoWindow.classList.add('mobile-info');
            }
            
            // Функция для обновления информации (координаты и легенда)
            function updateInfo(coordinate, pixel) {
              let layerDesc = '';
              let squareColor = '';
              map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                if (hiresVectorLayer && layer === hiresVectorLayer) {
                  layerDesc = 'SILAM Finland (v6.1)';
                  squareColor = 'rgba(0,120,255,1)';
                  return true;
                } else if (layer === regionalVectorLayer) {
                  layerDesc = 'SILAM Northern Europe (v5.9.1)';
                  squareColor = 'rgba(0,255,0,1)';
                  return true;
                } else if (layer === vectorLayer) {
                  layerDesc = 'SILAM Europe (v6.1/v6.0)';
                  squareColor = 'rgba(255,200,0,1)';
                  return true;
                }
              });
              
              let legendHtml = '';
              if (layerDesc) {
                legendHtml = `<div style="margin-bottom:3px;">
                  <span style="display:inline-block;width:14px;height:14px;background-color:${squareColor};vertical-align:middle;margin-right:5px;border:1px solid #000;"></span>
                  <span>${layerDesc}</span>
                </div>`;
              }
              
              const coordText = `${i18next.t('lat')}: ${coordinate[1].toFixed(3)}, ${i18next.t('lon')}: ${coordinate[0].toFixed(3)}`;
              infoWindow.innerHTML = legendHtml + coordText;
            }
            
            if (isMobile) {
              // Для мобильных устройств обновляем информацию по событию moveend (используем центр карты)
              map.on('moveend', function() {
                const center = ol.proj.toLonLat(map.getView().getCenter());
                const centerPixel = map.getPixelFromCoordinate(map.getView().getCenter());
                updateInfo(center, centerPixel);
              });
            } else {
              // Для десктопа обновляем информацию по событию pointermove
              map.on('pointermove', function(evt) {
                const coord = ol.proj.toLonLat(evt.coordinate);
                updateInfo(coord, evt.pixel);
                infoWindow.style.left = (evt.pixel[0] + 15) + 'px';
                infoWindow.style.top = (evt.pixel[1] + 15) + 'px';
              });
            }
            
            map.getView().fit(vectorSource.getExtent(), { padding: [10, 10, 10, 10] });
          };
        });
    </script>
  </body>
</html>